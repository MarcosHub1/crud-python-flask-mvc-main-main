{% extends 'base.html' %}

{% block content %}
  <h1>Olá, {{ current_user.nome }}!</h1>
  <p><strong>Email:</strong> {{ current_user.email }}</p>
          <a class="nav-link text-danger" href="{{ url_for('logout') }}">Logout</a>

  <hr>

  <h2>Seus Pets Cadastrados</h2>
  
  <form method="GET" action="{{ url_for('perfil') }}" class="mb-4 d-flex" role="search">
  <input 
    class="form-control me-2"
    type="search"
    name="q"
    placeholder="Pesquisar por nome ou descrição"
    value="{{ request.args.get('q', '') }}"
  >
  <button class="btn btn-outline-primary" type="submit">Pesquisar</button>
</form>

  {% if items %}
    <div class="row">
    {% for item in items %}
    
    <div class="col-md-4 mb-4">
      <div class="card h-100 shadow-sm">
        {% if item.imagem %}
        <img src="{{ url_for('static', filename='uploads/' ~ item.imagem) }}" class="card-img-top" style="height:220px; object-fit:cover;" alt="{{ item.nome }}">
        {% else %}
        <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height:220px;">
          <small>Sem imagem</small>
        </div>
        {% endif %}

        <div class="card-body d-flex flex-column">
          <h5 class="card-title mb-1">{{ item.nome }}</h5>
          <div class="mb-2">
            <small class="text-muted">{{ item.tipo or '—' }} • {{ item.idade or 'idade desconhecida' }}</small>
          </div>

          <p class="card-text text-truncate" style="max-height:3.6em; overflow:hidden;">
            {{ item.descricao or 'Sem descrição' }}
          </p>

          <div class="mt-auto">
            <p class="mb-2"><strong>Contato:</strong> {{ item.contato }}</p>

            <div class="d-flex gap-2">
              
              <!-- Abre modal com mais informações e edição -->
              <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#modal{{ item.id }}">Ver mais / Editar</button> 
              <!-- Delete -->
              <a href="{{ url_for('delete', id=item.id) }}"
                 class="btn btn-danger btn-sm"
                 onclick="return confirm('Tem certeza que deseja deletar {{ item.nome }}?');">
                 Deletar
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Modal: mostra detalhes e formulário de edição -->
    <div class="modal fade" id="modal{{ item.id }}" tabindex="-1" aria-labelledby="modalLabel{{ item.id }}" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <form method="POST" action="{{ url_for('update', id=item.id) }}" enctype="multipart/form-data">
            <div class="modal-header">
              <h5 class="modal-title" id="modalLabel{{ item.id }}">Editar — {{ item.nome }}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>

            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nome</label>
                  <input class="form-control" name="nome" value="{{ item.nome }}" required>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Tipo</label>
                  <input class="form-control" name="tipo" value="{{ item.tipo }}">
                </div>

                <div class="col-md-4">
                  <label class="form-label">Idade</label>
                  <input class="form-control" name="idade" value="{{ item.idade }}">
                </div>

                <div class="col-md-4">
                  <label class="form-label">Status</label>
                  <select class="form-select" name="status">
                    <option value="adocao" {% if item.status == 'adocao' %}selected{% endif %}>Para adoção</option>
                    <option value="perdido" {% if item.status == 'perdido' %}selected{% endif %}>Perdido</option>
                    <option value="encontrado" {% if item.status == 'encontrado' %}selected{% endif %}>Encontrado</option>
                  </select>
                </div>

                <div class="col-md-4">
                  <label class="form-label">Contato</label>
                  <input class="form-control" name="contato" value="{{ item.contato }}" required>
                </div>

                <div class="col-12">
                  <label class="form-label">Descrição</label>
                  <textarea class="form-control" name="descricao" rows="3">{{ item.descricao }}</textarea>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Foto atual</label>
                  {% if item.imagem %}
                    <div>
                      <img src="{{ url_for('static', filename='uploads/' ~ item.imagem) }}" alt="{{ item.nome }}" style="max-width:180px; height:auto; border-radius:6px;">
                    </div>
                  {% else %}
                    <div class="text-muted">Sem imagem</div>
                  {% endif %}
                </div>

                <div class="col-md-6">
                  <label class="form-label">Substituir foto</label>
                  <input type="file" class="form-control" name="imagem" accept="image/*">
                  <div class="form-text">Envie uma nova imagem para substituir a atual (opcional).</div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-success">Salvar alterações</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    {% endfor %}
  </div>
  {% else %}
    <p>Você ainda não cadastrou nenhum pet.</p>
    <a href="{{ url_for('create') }}">Cadastrar primeiro pet</a>
  {% endif %}
{% endblock %}
